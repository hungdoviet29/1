<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bảng Điều Khiển Quản Lý</title>
  <link rel="stylesheet" href="/stylesheets/style.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }

    header {
      background-color: #6c63ff;
      color: white;
      padding: 15px 20px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
    }

    .container {
      padding: 20px;
    }

    .summary-cards {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .card {
      background-color: white;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-radius: 10px;
      padding: 20px;
      width: 300px;
      margin: 10px;
      text-align: center;
    }

    .card h3 {
      margin: 0;
      color: #333;
    }

    .card p {
      font-size: 18px;
      color: #555;
    }

    nav {
      background-color: #fff;
      padding: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    nav ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      justify-content: center;
    }

    nav ul li {
      margin: 0 10px;
    }

    nav ul li a {
      text-decoration: none;
      color: #6c63ff;
      font-size: 16px;
      font-weight: bold;
    }

    nav ul li a:hover {
      text-decoration: underline;
    }

    .table-container {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    table th,
    table td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: center;
    }

    table th {
      background-color: #6c63ff;
      color: white;
    }
  </style>
</head>

<body>
  <header>Bảng Điều Khiển Quản Lý</header>

  <nav>
    <ul>

      <li><a href="manager.html">Đơn Hàng</a></li>
      <li>
        <a href="manager_laptops.html" style="text-decoration: none; color: #6c63ff;">Sản phẩm</a>
      </li>
      <li><a href="manager_user.html">Người Dùng</a></li>
      <li><a href="manager_discount.html">Voucher</a></li>
      <li><a href="manager_statistical.html">Thống kê</a></li>
      <li><a href="login.html">Đăng Xuất</a></li>
    </ul>
  </nav>

  <div class="container">
    <!-- Thẻ Tóm Tắt -->
    <div id="summary-cards-container"></div>


    <!-- Bảng Chi Tiết -->
    <div class="table-container">
      <h3>Thống kê</h3>
      <div class="filters">
        <label for="month">Tháng:</label>
        <select id="month">
          <option value="">Tất cả</option>
          <option value="1">Tháng 1</option>
          <option value="2">Tháng 2</option>
          <option value="3">Tháng 3</option>
          <option value="4">Tháng 4</option>
          <option value="5">Tháng 5</option>
          <option value="6">Tháng 6</option>
          <option value="7">Tháng 7</option>
          <option value="8">Tháng 8</option>
          <option value="9">Tháng 9</option>
          <option value="10">Tháng 10</option>
          <option value="11">Tháng 11</option>
          <option value="12">Tháng 12</option>
        </select>

        <label for="year">Năm:</label>
        <select id="year">
          <option value="">Tất cả</option>
          <option value="2022">2022</option>
          <option value="2023">2023</option>
          <option value="2024">2024</option>
          <option value="2025">2025</option>
        </select>

        <label for="start-date">Từ ngày:</label>
        <input type="date" id="start-date">

        <label for="end-date">Đến ngày:</label>
        <input type="date" id="end-date">

        <button id="filter-button">Lọc</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Mã Sản Phẩm</th>
            <th>Tên Sản Phẩm</th>
            <th>Số Lượng Bán</th>
            <th>Doanh Thu</th>
            <th>Từ ngày</th>
          </tr>
        </thead>
        <tbody id="statistics-body">
          <!-- Dữ liệu thống kê sẽ được hiển thị ở đây -->
        </tbody>
      </table>
    </div>


  </div>
  <script>
    document.getElementById("year").addEventListener("change", () => {
      const year = document.getElementById("year").value;
      const startDateInput = document.getElementById("start-date");
      const endDateInput = document.getElementById("end-date");

      if (year) {
        // Đặt ngày bắt đầu từ 1/1 của năm được chọn
        const startDate = new Date(`${year}-01-01T00:00:00Z`);
        // Đặt ngày kết thúc là 1/1 của năm tiếp theo
        const endDate = new Date(`${parseInt(year) + 1}-01-01T00:00:00Z`);
        startDateInput.value = startDate.toISOString().split("T")[0];
        endDateInput.value = endDate.toISOString().split("T")[0];
      } else {
        // Xóa giá trị nếu không chọn năm
        startDateInput.value = "";
        endDateInput.value = "";
      }
    });






    document.getElementById("month").addEventListener("change", () => {
      const month = document.getElementById("month").value;
      const year = document.getElementById("year").value || new Date().getFullYear();
      const startDateInput = document.getElementById("start-date");
      const endDateInput = document.getElementById("end-date");

      if (month) {
        const startDate = new Date(`${year}-${month.padStart(2, "0")}-01`);
        const endDate = new Date(`${year}-${(parseInt(month) + 1).toString().padStart(2, "0")}-01`);
        startDateInput.value = startDate.toISOString().split("T")[0];
        endDateInput.value = endDate.toISOString().split("T")[0];
      }
    });

    document.getElementById("filter-button").addEventListener("click", () => {
      const month = document.getElementById("month").value;
      const year = document.getElementById("year").value;
      const startDate = document.getElementById("start-date").value;
      const endDate = document.getElementById("end-date").value;

      const statisticsBody = document.getElementById("statistics-body");
      statisticsBody.innerHTML = ""; // Xóa dữ liệu cũ

      // Gọi API đơn hàng
      fetch("http://192.168.0.7:3000/donhang")
        .then(response => response.json())
        .then(orders => {
          // Lọc đơn hàng theo ngày, tháng, và năm
          const filteredOrders = orders.filter(order => {
            const orderDate = new Date(order.createdAt);

            const isMonthMatch = month ? orderDate.getMonth() + 1 === parseInt(month) : true;
            const isYearMatch = year ? orderDate.getFullYear() === parseInt(year) : true;
            const isStartMatch = startDate ? orderDate >= new Date(startDate) : true;
            const isEndMatch = endDate ? orderDate <= new Date(endDate) : true;

            return isMonthMatch && isYearMatch && isStartMatch && isEndMatch;
          });

          // Tính toán thống kê
          const statistics = {};
          filteredOrders.forEach(order => {
            order.cartItems.forEach(item => {
              const productId = item.productId?._id || "unknown";
              const productName = item.productId?.ten || "Sản phẩm không xác định";
              const productPrice = item.productId?.gia || 0;

              if (!statistics[productId]) {
                statistics[productId] = {
                  id: productId,
                  name: productName,
                  sold: 0,
                  revenue: 0,
                };
              }
              statistics[productId].sold += item.quantity;
              statistics[productId].revenue += item.quantity * productPrice;
            });
          });

          // Hiển thị dữ liệu thống kê
          const sortedStatistics = Object.values(statistics).sort((a, b) => b.sold - a.sold);

          sortedStatistics.forEach(stat => {
            const row = document.createElement("tr");
            row.innerHTML = `
                        <td>${stat.id}</td>
                        <td>${stat.name}</td>
                        <td>${stat.sold}</td>
                        <td>${stat.revenue.toLocaleString()} VND</td>
                        <td>${startDate || "Toàn thời gian"}</td>
                    `;
            statisticsBody.appendChild(row);
          });
        })
        .catch(error => console.error("Lỗi khi tải dữ liệu thống kê:", error));
    });
  </script>


</body>

</html>